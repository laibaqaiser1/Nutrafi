generator client {
  provider      = "prisma-client"
  output        = "../lib/generated/prisma"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      UserRole @default(CHEF)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
}

model Dish {
  id            String         @id @default(cuid())
  name          String
  description   String?
  category      DishCategory
  ingredients   String?
  allergens     String?
  calories      Int
  protein       Float
  carbs         Float
  fats          Float
  price         Float?
  status        String         @default("ACTIVE")
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  mealPlanItems MealPlanItem[]

  @@index([category])
  @@index([status])
  @@index([name])
}

model Customer {
  id           String         @id @default(cuid())
  fullName     String
  phone        String
  email        String?
  address      String
  deliveryArea String
  status       CustomerStatus @default(ACTIVE)
  notes        String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  mealPlans    MealPlan[]
  payments     Payment[]

  @@index([status])
  @@index([deliveryArea])
  @@index([phone])
  @@index([fullName])
}

model Plan {
  id          String     @id @default(cuid())
  name        String
  planType    PlanType
  days        Int
  mealsPerDay Int
  price       Float
  description String?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  mealPlans   MealPlan[]
  payments    Payment[]

  @@index([isActive])
}

model MealPlan {
  id              String         @id @default(cuid())
  customerId      String
  planId          String?
  startDate       DateTime?
  endDate         DateTime?
  mealsPerDay     Int
  status          String         @default("ACTIVE")
  notes           String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  averageMealRate Float?
  baseAmount      Float?
  days            Int
  planType        PlanType
  remainingMeals  Int?
  totalAmount     Float?
  totalMeals      Int?
  vatAmount       Float?
  customer        Customer       @relation(fields: [customerId], references: [id], onDelete: Cascade)
  plan            Plan?          @relation(fields: [planId], references: [id])
  mealPlanItems   MealPlanItem[]
  payments        Payment[]

  @@index([customerId])
  @@index([startDate])
  @@index([endDate])
  @@index([status])
  @@index([planType])
}

model MealPlanItem {
  id              String        @id @default(cuid())
  mealPlanId      String
  dishId          String?
  date            DateTime
  timeSlot        String
  isSkipped       Boolean       @default(false)
  customNote      String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  isDelivered     Boolean       @default(false)
  deliveredAt     DateTime?
  allergens       String?
  calories        Int?
  carbs           Float?
  deliveryTime    String?
  dishCategory    DishCategory?
  dishDescription String?
  dishName        String?
  fats            Float?
  ingredients     String?
  price           Float?
  protein         Float?
  dish            Dish?         @relation(fields: [dishId], references: [id])
  mealPlan        MealPlan      @relation(fields: [mealPlanId], references: [id], onDelete: Cascade)

  @@unique([mealPlanId, date, timeSlot])
  @@index([mealPlanId])
  @@index([date])
  @@index([timeSlot])
  @@index([dishId])
  @@index([dishCategory])
}

model Payment {
  id            String    @id @default(cuid())
  customerId    String
  mealPlanId    String?
  planId        String?
  amount        Float
  paymentDate   DateTime  @default(now())
  paymentMethod String?
  status        String    @default("PENDING")
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  customer      Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  mealPlan      MealPlan? @relation(fields: [mealPlanId], references: [id])
  plan          Plan?     @relation(fields: [planId], references: [id])

  @@index([customerId])
  @@index([mealPlanId])
  @@index([paymentDate])
  @@index([status])
}

enum UserRole {
  ADMIN
  MANAGER
  CHEF
}

enum DishCategory {
  BREAKFAST
  LUNCH
  DINNER
  SNACK
  SMOOTHIE
  JUICE
  LUNCH_DINNER
}

enum PlanType {
  WEEKLY
  MONTHLY
  CUSTOM
}

enum CustomerStatus {
  ACTIVE
  PAUSED
  CANCELLED
}
